<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# website: http://ogp.me/ns/website#">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="description" content="">
    <meta property="og:title" content="Building Modular Systems with mbt">
    
    <meta property="og:type" content="article">
    <meta property="article:published_time" content="2017-10-07">
    
    <meta property="og:description" content="">
    <meta property="og:url" content="https://buddyspike.github.io/blog/post/building-moduler-systems-with-mbt/">
    <meta property="og:site_name" content="buddyspike">
    
    <meta property="og:tags" content="mbt">
    
    <meta property="og:tags" content="build">
    
    <meta property="og:tags" content="dev-ops">
    
    <meta property="og:tags" content="monorepo">
    
    <meta name="generator" content="Hugo 0.23" />
    <title>Building Modular Systems with mbt &middot; buddyspike</title>
    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/styles/default.min.css">
    
    <link rel="stylesheet" href="https://buddyspike.github.io/blog/css/style.css">
    
    <link href="https://buddyspike.github.io/blog/index.xml" rel="alternate" type="application/rss+xml" title="buddyspike" />
    
    
    <link rel="icon" href="https://buddyspike.github.io/blog//img/me.png" />
    

    
    
</head>
<body>

<nav class="navbar navbar-default navbar-fixed-top visible-xs">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
				<a class="navbar-brand" href="https://buddyspike.github.io/blog/">buddyspike</a>
			
		</div>
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				
				
					<li><a href="https://buddyspike.github.io/blog/about">About</a></li>
				
					<li><a href="https://buddyspike.github.io/blog/">Blog</a></li>
				
			</ul>
		</div>
	</div>
</nav>
<div class="container-fluid">
	<div class="row">
		<div id="menu" class="hidden-xs col-sm-4 col-md-3">
	<div id="menu-content" class="vertical-align">
		
			<h1 class="text-center"><a href="https://buddyspike.github.io/blog/">buddyspike</a></h1>
		
		
		
		
		
		<div id="social" class="text-center">
			
				<a href="https://github.com/buddyspike"><i class="fa fa-github fa-2x"></i></a>
			
				<a href="https://twitter.com/buddyspike28"><i class="fa fa-twitter fa-2x"></i></a>
			

			<a href="mailto:buddyspike@geeksdiary.com"><i class="fa fa-envelope-o fa-2x"></i></a>
		</div>
		<div id="links" class="text-center">
			
			
				<a href="https://buddyspike.github.io/blog/about">About</a>
			
				<a href="https://buddyspike.github.io/blog/">Blog</a>
			
		</div>
	</div>
</div>

		<div id="content" class="col-xs-12 col-sm-8 col-md-9">
			<div class="row">
				<div id="post" class="col-sm-offset-1 col-sm-10 col-md-10 col-lg-8">

<main>
	<header>
		<h1>Building Modular Systems with mbt</h1>
	</header>

	<article>
		

<p>Large systems are usually constructed by composing many small systems. My favorite
browser for example distributes its work across different processes while
I&rsquo;m conveniently enjoying my morning dose of hacker news. <img src="/img/chromium-task-manager.png" alt="Chromium task manager" /></p>

<p>This also applies to server side systems with the added complexity of
modules being distributed across multiple machines, built using different
tool-chains etc.</p>

<p>Modularisation is great as it gives us the ability to reduce coupling and
cohesion. However, ultimately, we are only interested in the overall
state of the system rather than the individual modules. Therefore it is worth
exploring what we consider as the overall system state.</p>

<p>Imagine a system of two modules <code>A</code> and <code>B</code> for instance.
The overall state of this system is a set
<code>{A1, B1}</code> where <code>A1, B1</code> are versions of <code>A</code> and <code>B</code>. If <code>A</code> and <code>B</code>
both had multiple version choices and system is composed by choosing 2, how
many combinations we can make? There&rsquo;s a <a href="http://mathworld.wolfram.com/BinomialCoefficient.html">formula</a> for that if we
want to be sure. The point is, the number of combinations that make up the system
increases with the number of modules and their versions.</p>

<p>Tracking these combinations gives us the ability to reason about how
the system changes over time. Nowadays, for this type of tracking we
use source control systems but there are two distinct patterns in
terms of how they are organised.</p>

<ul>
<li>All modules are stored in one source repository</li>
<li>Each module is maintained in its own repository</li>
</ul>

<p>Both approaches require some tooling to establish the state of the system.
Chromium for example consists of multiple independent modules
such as <a href="https://chromium.googlesource.com/v8/v8.git">V8</a> and <a href="https://webrtc.googlesource.com/src.git">webrtc</a> uses <a href="https://chromium.googlesource.com/chromium/tools/depot_tools/+/master/fetch.py">depot_tools</a> to archive this.</p>

<p>For the rest of this post our focus is going to be on <a href="https://github.com/buddyspike/mbt">mbt</a> which
is a tool for building modular systems stored in a single git repository.</p>

<h2 id="design-goals">Design goals</h2>

<p>mbt is designed as a tool to orchestrate existing build tools rather than
an alternative to a build runner like <code>make</code>, <code>msbuild</code> or <code>maven</code>. Below we
discuss a few design goals of mbt.</p>

<h3 id="integrate-with-current-build-utilities">Integrate with current build utilities</h3>

<p>mbt is a cli tool that can be used locally or inside current build systems like <a href="https://jenkins.io">Jenkins</a>, <a href="https://www.jetbrains.com/teamcity/">Teamcity</a>.</p>

<h3 id="declarative">Declarative</h3>

<p>Much like <a href="https://travis-ci.org">Travis</a> and <a href="https://www.appveyor.com/">AppVeyor</a>, mbt
discovers your modules by a spec file you place in the root of each module directory.
Spec file must be called <code>.mbt.yml</code> and the content instructing how to build your
module is formatted in <a href="http://yaml.org/spec/">yaml</a>.</p>

<p>For example consider the following <code>.mbt.yml</code> file.</p>

<pre><code class="language-yaml">name: my-app
build:
  windows:
    cmd: powershell
    args: [-ExecutionPolicy, Bypass, -File, .\build.ps1]
  linux:
    cmd: ./build.sh
</code></pre>

<p>With this file committed to your repository, you can trigger the build for
the master branch by running the following mbt command.</p>

<pre><code class="language-sh">mbt build branch master --in [path to repo]
</code></pre>

<p>When the preceding command is executed in a windows host, it would run <code>build.ps1</code>
bypassing the execution policy. On a linux host, it would run <code>build.sh</code> file.</p>

<p>With this approach mbt gives you the complete control over what to be done
when build is executed.</p>

<h3 id="fast">Fast</h3>

<p>When a repository contains only a single module, build is triggered by changes to
that module. However, when multiple modules are stored together, if a change to
one module triggers the build of all modules, build system will not be scalable.</p>

<p>mbt provides options to execute the builds only for the changed modules. It works
out the changes automatically by integrating with git.</p>

<pre><code class="language-sh"># build the diff of two branches
mbt build pr --src [source branch name] --dst [destination branch name] --in [path to repo] 

# build the diff of two commits
mbt build diff --from [commit sha] --to [commit sha] --in [path to repo]

</code></pre>

<h3 id="consistent">Consistent</h3>

<p>Tagging the builds with the git commit sha or build runner&rsquo;s build number
is a typical approach when building single module repositories.
For multiple module repositories however,
if we are not intending to build all modules for each commit, commit sha would
not be representative build tag.</p>

<p>To solve this problem, when building the source tree for a particular commit,
mbt calculates a SHA1 hash for each module based on the content of module directory stored
in git tree. This gives a consistent version tag across multiple commits for modules that haven&rsquo;t been changed.</p>

<p>The mechanics of this hash calculation is similar to
how git tree objects are hashed <a href="https://git-scm.com/book/en/v2/Git-Internals-Git-Objects">internally</a>.</p>

<p>Among other module specific attributes, the version tag calculated for
each module is available to your build tools via <code>MBT_APP_VERSION</code>
environment variable.</p>

<h3 id="template-processing">Template processing</h3>

<p>When a build is executed by mbt, it builds up metadata about modules in your repository.
The metadata consists of the module version number and attributes you specified in <code>.mbt.yml</code> file.
At this point it&rsquo;s also worth noting that <code>.mbt.yml</code> allows you to store arbitrary data structure
under its <code>properties</code> field as shown below.</p>

<pre><code class="language-yaml">name: my-app
build:
  windows:
    cmd: powershell
    args: [-ExecutionPolicy, Bypass, -File, .\build.ps1]
  linux:
    cmd: ./build.sh
properties:
  type: spa     # these key-value pairs can be anything
  path: my-app
  nested:       # they can also be nested multiple times
    foo: bar    
</code></pre>

<p>mbt exposes its metadata system to templates you write in <a href="https://golang.org/pkg/text/template/">go</a>.</p>

<p>For instance, the following template can be used to generate a text document
with all modules and their version.</p>

<pre><code class="language-go">{{range $app := .Applications}}
{{$app.Name}} {{$app.Version}}
{{end}}
</code></pre>

<p>Provided the template is stored in your repository, you can run the following command
generate a list of modules and their version in master branch.</p>

<pre><code class="language-sh">mbt apply branch master --to [path to template] --in [path to repo]
</code></pre>

<p>A text file with a list of modules and their version might be of little use. But the same
technique can be used to generate more useful artifacts such as</p>

<ul>
<li>Custom deployment scripts (e.g. Powershell scripts that configures modules in IIS)</li>
<li>nginx configs</li>
<li>AWS Cloud Formation Templates</li>
<li>Azure Resource Templates</li>
<li>Kubernetes deployment files</li>
</ul>

<h3 id="wrap-up">Wrap up</h3>

<p>That&rsquo;s a quick tour of motivations behind mbt.
It is still quite young and under a lot of churn.
Do you think mbt would help you with a build problem you&rsquo;ve been wrestling with lately?</p>

	</article>
</main>

<div id="bottom-nav" class="text-center center-block">
	<a href=" https://buddyspike.github.io/blog/" class="btn btn-default"><i class="fa fa-home"></i> Home</a>
</div>


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'buddyspike';
    var disqus_identifier = 'https:\/\/buddyspike.github.io\/blog\/post\/building-moduler-systems-with-mbt\/';
    var disqus_title = 'Building Modular Systems with mbt';
    var disqus_url = 'https:\/\/buddyspike.github.io\/blog\/post\/building-moduler-systems-with-mbt\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


						</div>
					</div>
				</div>
			</div>
		</div>
  </div>
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-57052137-3', 'auto');
    ga('send', 'pageview');
    window.baseURL = "https:\/\/buddyspike.github.io\/blog\/";
  </script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/js/bootstrap.min.js"></script>
  
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script>
  
  <script src="https://buddyspike.github.io/blog//js/App.js"></script>
  
</body>
</html>
